<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Book Manager</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container py-5">
    <h1 class="mb-3 text-center">ðŸ“š Book Manager</h1>
    <div class="mb-4 d-flex gap-2 align-items-center">
        <input type="text" id="tokenInput" class="form-control" placeholder="Enter API Token (from admin or /api-token-auth/)" />
        <button class="btn btn-secondary" id="saveTokenBtn">Save Token</button>
    </div>

    <form id="bookForm" class="mb-4">
        <input type="hidden" id="bookId">
        <div class="mb-2"><input type="text" id="title" class="form-control" placeholder="Title" required></div>
        <div class="mb-2"><input type="text" id="author" class="form-control" placeholder="Author" required></div>
        <div class="mb-2"><input type="date" id="published_date" class="form-control" required></div>
        <button class="btn btn-primary" type="submit">Add / Update Book</button>
    </form>

    <table class="table table-striped">
        <thead><tr><th>Title</th><th>Author</th><th>Date</th><th>Actions</th></tr></thead>
        <tbody id="bookTable"></tbody>
    </table>

    <script>
        const API_URL = '/api/books/';
        const TOKEN_STORAGE_KEY = 'apiToken';
        function getToken() {
            return localStorage.getItem(TOKEN_STORAGE_KEY) || '';
        }
        function getAuthHeaders() {
            const token = getToken();
            return token ? { 'Authorization': `Token ${token}` } : {};
        }

        async function loadBooks() {
            const res = await fetch(API_URL, { headers: getAuthHeaders() });
            const books = await res.json();
            const table = document.getElementById('bookTable');
            table.innerHTML = '';
            books.forEach(book => {
                table.innerHTML += `
                    <tr>
                        <td>${book.title}</td>
                        <td>${book.author}</td>
                        <td>${book.published_date}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editBook(${book.id}, '${book.title}', '${book.author}', '${book.published_date}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBook(${book.id})">Delete</button>
                        </td>
                    </tr>`;
            });
        }

        async function deleteBook(id) {
            await fetch(API_URL + id + '/', { method: 'DELETE', headers: getAuthHeaders() });
            loadBooks();
        }

        function editBook(id, title, author, date) {
            document.getElementById('bookId').value = id;
            document.getElementById('title').value = title;
            document.getElementById('author').value = author;
            document.getElementById('published_date').value = date;
        }

        document.getElementById('bookForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('bookId').value;
            const bookData = {
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                published_date: document.getElementById('published_date').value
            };
            if (id) {
                await fetch(API_URL + id + '/', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                    body: JSON.stringify(bookData)
                });
            } else {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                    body: JSON.stringify(bookData)
                });
            }
            document.getElementById('bookForm').reset();
            loadBooks();
        });

        // Save token UI wiring
        document.getElementById('saveTokenBtn').addEventListener('click', () => {
            const token = (document.getElementById('tokenInput').value || '').trim();
            if (token) {
                localStorage.setItem(TOKEN_STORAGE_KEY, token);
                alert('Token saved. Reloading books...');
                loadBooks();
            } else {
                alert('Please enter a token');
            }
        });
        // Pre-fill token input if already saved
        document.getElementById('tokenInput').value = getToken();

        loadBooks();
    </script>
</body>
</html>
